<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Quiniela Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --gold:#c8a13a;
  --dark:#1c1c1c;
  --bg:#f4f4f4;
  --tab:#2e2e2e;
  --tab-active:#c8a13a;
}

body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:var(--bg);
  color:#222;
}

header{
  background:linear-gradient(135deg,#111,#333);
  color:white;
  padding:20px;
  text-align:center;
  font-size:22px;
  letter-spacing:1px;
}

.tabs{
  display:flex;
  background:var(--tab);
}

.tabs button{
  flex:1;
  padding:12px;
  border:none;
  background:var(--tab);
  color:white;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
}

.tabs button:hover{
  background:#444;
}

.tabs button.active{
  background:var(--tab-active);
  color:black;
}

.tab{
  display:none;
  padding:20px;
}

.tab.active{
  display:block;
}

.partido{
  display:grid;
  grid-template-columns:1fr 70px;
  gap:10px;
  margin-bottom:8px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}

th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}

th{
  background:#222;
  color:white;
}

tr:nth-child(even){
  background:#f2f2f2;
}

.doble{
  color:var(--gold);
  font-weight:bold;
}

.pleno-box{
  margin-top:15px;
  padding:12px;
  background:#fff7e0;
  border-left:5px solid var(--gold);
}

footer{
  text-align:center;
  padding:15px;
  font-size:12px;
  color:#666;
}
</style>
</head>

<body>

<header>‚öΩ Quiniela del Grupo</header>
  <div id="estadoBanner" style="
  text-align:center;
  padding:8px;
  font-weight:bold;
  background:#eee;
"></div>

<div style="padding:15px;">
<label>¬øQui√©n eres?</label>
<select id="usuario"></select>
</div>

<div class="tabs">
  <button onclick="mostrar('votar')" id="tabVotar" class="active">Votar</button>
  <button onclick="mostrar('ultima')" id="tabUltima">√öltima jornada</button>
  <button onclick="mostrar('historico')" id="tabHistorico">Hist√≥rico</button>
  <button onclick="mostrar('clasificacion')" id="tabClasificacion">Clasificaci√≥n</button>
</div>
  
  <!-- BOTONES ADMIN -->
<div style="text-align:center; margin:10px 0;">
  <button onclick="cerrarVotacionesAdmin()">Cerrar votaciones</button>
  <button onclick="cerrarJornadaAdmin()">Cerrar jornada</button>
</div>

<!-- ================= VOTAR ================= -->
<div id="votar" class="tab active">
  <h2>Realiza tu pron√≥stico</h2>
  <div id="partidos"></div>

  <h3>Pleno al 15</h3>
  <div id="pleno"></div>

  <button onclick="enviarVoto()">Enviar quiniela</button>
</div>

<!-- ================= √öLTIMA ================= -->
<div id="ultima" class="tab">
  <h2>√öltima jornada cerrada</h2>
  <div id="ultimaContenido"></div>
</div>

<!-- ================= HISTORICO ================= -->
<div id="historico" class="tab">
  <h2>Hist√≥rico de jornadas</h2>
  <label>Selecciona jornada:</label>
  <select id="selectorJornada"></select>
  <div id="historicoContenido"></div>
</div>

<!-- ================= CLASIFICACION ================= -->
<div id="clasificacion" class="tab">
  <h2>Clasificaci√≥n general</h2>
  <div id="tablaClasificacion"></div>
</div>

<footer>Sistema autom√°tico de quinielas</footer>

<script>
const URL="https://script.google.com/macros/s/AKfycbyWndKiIZ1C7EoQOqOxjPscMbwQj1LmO39bT1DeNImP_Kga6Ub_Sy5sETl8Q678kdBd/exec";

/* ================= NAVEGACION ================= */
function mostrar(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.getElementById("tab"+id.charAt(0).toUpperCase()+id.slice(1)).classList.add("active");

  if(id==="ultima") cargarUltima();
  if(id==="historico") cargarHistorico();
  if(id==="clasificacion") cargarClasificacion();
}

/* ================= USUARIOS ================= */
fetch(URL+"?action=usuarios")
.then(r=>r.json())
.then(u=>{
  usuario.innerHTML="<option value=''>--</option>";
  u.forEach(n=>usuario.innerHTML+=`<option>${n}</option>`);
});

/* ================= PARTIDOS ================= */
fetch(URL+"?action=partidos")
.then(r=>r.json())
.then(p=>{
  partidos.innerHTML="";
  p.forEach(x=>{
    partidos.innerHTML+=`
      <div class="partido">
        <span>${x.nombre}</span>
        <select name="p${x.id}">
          <option></option><option>1</option><option>X</option><option>2</option>
        </select>
      </div>`;
  });
});

/* ================= PLENO ================= */
fetch(URL+"?action=pleno")
.then(r=>r.json())
.then(p=>{
  pleno.innerHTML=`
    <div class="partido">
      <span>${p.local}</span>
      <select id="pl15_local">
        <option></option><option>0</option><option>1</option><option>2</option><option>M</option>
      </select>
    </div>
    <div class="partido">
      <span>${p.visitante}</span>
      <select id="pl15_visitante">
        <option></option><option>0</option><option>1</option><option>2</option><option>M</option>
      </select>
    </div>`;
});

/* ================= ULTIMA COMPLETA ================= */
function cargarUltima(){
  fetch(URL+"?action=ultimaCompleta")
  .then(r=>r.json())
  .then(d=>{
    if(!d || !d.quiniela){
      ultimaContenido.innerHTML="No hay jornadas cerradas.";
      return;
    }

    let html="<h3>Votos</h3>";
    html+=renderTablaVotos(d.votos, d.partidosNombres);

    html+="<h3>Quiniela final</h3>";
    html+=renderQuiniela(d.quiniela, d.partidosNombres);

    html+="<div class='pleno-box'><strong>Pleno al 15</strong><br>";
    html+=d.pleno.localNombre+" "+d.pleno.localResultado+
          " - "+
          d.pleno.visitanteResultado+" "+d.pleno.visitanteNombre;
    html+="</div>";

    ultimaContenido.innerHTML=html;
  });
}

/* ================= HISTORICO ================= */
function cargarHistorico(){
  fetch(URL+"?action=historico")
  .then(r=>r.json())
  .then(data=>{
    if(!data.length){
      historicoContenido.innerHTML="No hay jornadas guardadas.";
      return;
    }

    const jornadas=[...new Set(data.map(r=>r[0]))];
    selectorJornada.innerHTML="";
    jornadas.forEach(j=>{
      selectorJornada.innerHTML+=`<option value="${j}">Jornada ${j}</option>`;
    });

    selectorJornada.onchange=()=>mostrarJornada(data);
    selectorJornada.onchange();
  });
}

function mostrarJornada(data){
  const j=selectorJornada.value;
  const fila=data.find(r=>r[0]==j);
  if(!fila) return;

  const obj=JSON.parse(fila[3]);

  let html="<h3>Votos</h3>";
 html+=renderTablaVotos(obj.votos, obj.partidosNombres);

  html+="<h3>Quiniela final</h3>";
  html+=renderQuiniela(obj.quiniela, obj.partidosNombres);
  html+="<div class='pleno-box'><strong>Pleno al 15</strong><br>";
  html+=obj.pleno.localNombre+" "+obj.pleno.localResultado+
        " - "+
        obj.pleno.visitanteResultado+" "+obj.pleno.visitanteNombre;
  html+="</div>";

  historicoContenido.innerHTML=html;
}

/* ================= TABLA VOTOS ================= */
function renderTablaVotos(votos, partidosNombres){
  const usuarios = Object.keys(votos);
  let html = "<table><tr><th>Partido</th>";
  usuarios.forEach(u => html += "<th>" + u + "</th>");
  html += "</tr>";

  for(let i = 1; i <= 14; i++){
    const nombre = (partidosNombres && partidosNombres[i-1])
      ? partidosNombres[i-1]
      : "Partido " + i;

    html += "<tr><td>" + nombre + "</td>";
    usuarios.forEach(u => {
      html += "<td>" + (votos[u][i] || "") + "</td>";
    });
    html += "</tr>";
  }

  html += "<tr><td>Pleno L</td>";
  usuarios.forEach(u => html += "<td>" + (votos[u]["PL15_LOCAL"] || "") + "</td>");
  html += "</tr>";

  html += "<tr><td>Pleno V</td>";
  usuarios.forEach(u => html += "<td>" + (votos[u]["PL15_VISIT"] || "") + "</td>");
  html += "</tr>";

  html += "</table>";
  return html;
}

/* ================= QUINIELA ================= */
function renderQuiniela(q, partidosNombres){
  let html = "";

  q.partidos.forEach(p => {
    const nombre = (partidosNombres && partidosNombres[p.partido - 1])
      ? partidosNombres[p.partido - 1]
      : "Partido " + p.partido;

    const esDoble = q.dobles.includes(p.partido);

    html += `<div>
      ${nombre} ‚Üí 
      <span class="${esDoble ? 'doble' : ''}">
        ${esDoble ? p.principal + " / " + p.segundo : p.principal}
      </span>
    </div>`;
  });

  return html;
}

/* ================= CLASIFICACION ================= */
function cargarClasificacion(){
  fetch(URL+"?action=clasificacion")
  .then(r=>r.json())
  .then(d=>{
    let html="<table><tr><th>üèÜ</th><th>Usuario</th><th>Puntos</th></tr>";
    d.slice(1).sort((a,b)=>b[1]-a[1]).forEach((r,i)=>{
      html+=`<tr>
        <td>${i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":""}</td>
        <td>${r[0]}</td>
        <td>${r[1]}</td>
      </tr>`;
    });
    html+="</table>";
    tablaClasificacion.innerHTML=html;
  });
}
  /* ================= ENVIAR VOTO ================= */
window.enviarVoto = function(){

  const usuarioSelect = document.getElementById("usuario");
  const usuario = usuarioSelect.value;

  if(!usuario){
    alert("Selecciona usuario");
    return;
  }

  const params = new URLSearchParams();
  params.append("usuario", usuario);

  document.querySelectorAll("select[name^='p']").forEach(select=>{
    params.append(select.name, select.value);
  });

  const plenoLocal = document.getElementById("pl15_local");
  const plenoVisit = document.getElementById("pl15_visitante");

  if(!plenoLocal || !plenoVisit){
    alert("Error cargando pleno al 15");
    return;
  }

  params.append("pl15_local", plenoLocal.value);
  params.append("pl15_visitante", plenoVisit.value);

  fetch(URL + "?" + params.toString())
    .then(r=>r.text())
    .then(response=>{
      alert(response);
    })
    .catch(error=>{
      console.error(error);
      alert("Error enviando voto");
    });
};
/* ================= ESTADO ================= */
function cargarEstado(){
  fetch(URL+"?action=estado")
  .then(r=>r.json())
  .then(d=>{
    const banner=document.getElementById("estadoBanner");

    if(d.estado==="abierta"){
      banner.innerHTML="üü¢ Votaciones abiertas";
      banner.style.background="#d4edda";
      habilitarVoto(true);
    }

    if(d.estado==="votaciones_cerradas"){
      banner.innerHTML="üîí Votaciones cerradas - Quiniela enviada";
      banner.style.background="#f8d7da";
      habilitarVoto(false);
    }
  });
}

function habilitarVoto(permitido){
  const boton=document.querySelector("#votar button");
  if(boton){
    boton.disabled=!permitido;
    boton.style.opacity=permitido?1:0.5;
  }
}

/* ================= ADMIN ================= */
function cerrarVotacionesAdmin(){
  fetch(URL+"?action=cerrarVotaciones")
  .then(r=>r.json())
  .then(d=>{
    alert(d.mensaje || "Votaciones cerradas");
    cargarEstado();
  });
}

function cerrarJornadaAdmin(){
  fetch(URL+"?action=cerrarJornada")
  .then(r=>r.text())
  .then(t=>{
    alert(t);
    cargarEstado();
  });
}
cargarEstado();
</script>

</body>
</html>
