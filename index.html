<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Quiniela Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --gold:#c8a13a;
  --dark:#1c1c1c;
  --bg:#f4f4f4;
  --tab:#2e2e2e;
  --tab-active:#c8a13a;
}

body{
  margin:0;
  font-family: 'Segoe UI', sans-serif;
  background:var(--bg);
  color:#222;
}

/* HEADER */
header{
  background:linear-gradient(135deg,#111,#333);
  color:white;
  padding:20px;
  text-align:center;
  font-size:22px;
  letter-spacing:1px;
}

/* TABS */
.tabs{
  display:flex;
  background:var(--tab);
}
.tabs button{
  flex:1;
  padding:12px;
  border:none;
  background:var(--tab);
  color:white;
  font-weight:600;
  cursor:pointer;
  transition:0.3s;
}
.tabs button:hover{
  background:#444;
}
.tabs button.active{
  background:var(--tab-active);
  color:#000;
}

/* SECCIONES */
.tab{
  display:none;
  padding:20px;
}
.tab.active{
  display:block;
}

/* PARTIDOS */
.partido{
  display:grid;
  grid-template-columns:1fr 70px;
  gap:10px;
  margin-bottom:8px;
}
.partido select{
  width:70px;
  padding:4px;
}

/* TABLAS */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
}
th{
  background:#222;
  color:white;
}
tr:nth-child(even){
  background:#f2f2f2;
}

/* DOBLE */
.doble{
  color:var(--gold);
  font-weight:bold;
}

/* PLENO */
.pleno-box{
  margin-top:15px;
  padding:12px;
  background:#fff7e0;
  border-left:5px solid var(--gold);
}

/* CLASIFICACION */
.copa{
  font-size:20px;
  margin-right:5px;
}

footer{
  text-align:center;
  padding:15px;
  font-size:12px;
  color:#666;
}
</style>
</head>

<body>

<header>
‚öΩ Quiniela del Grupo
</header>

<div style="padding:15px;">
<label>¬øQui√©n eres?</label>
<select id="usuario"></select>
</div>

<div class="tabs">
  <button onclick="mostrar('votar')" id="tabVotar">Votar</button>
  <button onclick="mostrar('ultima')" id="tabUltima">√öltima jornada</button>
  <button onclick="mostrar('clasificacion')" id="tabClasificacion">Clasificaci√≥n</button>
</div>

<!-- ================= VOTAR ================= -->
<div id="votar" class="tab active">
  <h2>Realiza tu pron√≥stico</h2>
  <div id="partidos"></div>

  <h3>Pleno al 15</h3>
  <div id="pleno"></div>

  <button onclick="enviarVoto()">Enviar quiniela</button>
</div>

<!-- ================= √öLTIMA ================= -->
<div id="ultima" class="tab">
  <h2>√öltima jornada cerrada</h2>
  <div id="ultimaContenido"></div>
</div>

<!-- ================= CLASIFICACION ================= -->
<div id="clasificacion" class="tab">
  <h2>Clasificaci√≥n general</h2>
  <div id="tablaClasificacion"></div>
</div>

<footer>
Sistema autom√°tico de quinielas
</footer>

<script>
const URL="https://script.google.com/macros/s/AKfycbyzXlFn5NmvvpZuoano1yG37zuWbAjorRlZsK2t0mg64Ug0PXTBTH4_uCJK5OpsRY6t/exec";

/* NAV */
function mostrar(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.getElementById("tab"+id.charAt(0).toUpperCase()+id.slice(1)).classList.add("active");

  if(id==="ultima") cargarUltima();
  if(id==="clasificacion") cargarClasificacion();
}

/* USUARIOS */
fetch(URL+"?action=usuarios")
.then(r=>r.json())
.then(u=>{
  usuario.innerHTML="<option value=''>--</option>";
  u.forEach(n=>usuario.innerHTML+=`<option>${n}</option>`);
});

/* PARTIDOS */
fetch(URL+"?action=partidos")
.then(r=>r.json())
.then(p=>{
  p.forEach(x=>{
    partidos.innerHTML+=`
      <div class="partido">
        <span>${x.nombre}</span>
        <select name="p${x.id}">
          <option></option><option>1</option><option>X</option><option>2</option>
        </select>
      </div>`;
  });
});

/* PLENO */
fetch(URL+"?action=pleno")
.then(r=>r.json())
.then(p=>{
  pleno.innerHTML=`
    <div class="partido">
      <span>${p.local}</span>
      <select id="pl15_local">
        <option></option><option>0</option><option>1</option><option>2</option><option>M</option>
      </select>
    </div>
    <div class="partido">
      <span>${p.visitante}</span>
      <select id="pl15_visitante">
        <option></option><option>0</option><option>1</option><option>2</option><option>M</option>
      </select>
    </div>`;
});

/* ENVIAR */
function enviarVoto(){
  if(!usuario.value){alert("Selecciona usuario");return;}
  const p=new URLSearchParams();
  p.append("usuario",usuario.value);
  document.querySelectorAll("select[name^='p']").forEach(s=>p.append(s.name,s.value));
  p.append("pl15_local",pl15_local.value);
  p.append("pl15_visitante",pl15_visitante.value);
  fetch(URL+"?"+p).then(r=>r.text()).then(t=>alert(t));
}

/* √öLTIMA COMPLETA */
function cargarUltima(){
  fetch(URL+"?action=ultimaCompleta")
  .then(r=>r.json())
  .then(d=>{
    if(!d || !d.quiniela){ ultimaContenido.innerHTML="No hay jornadas cerradas."; return;}

    let html="<h3>Votos</h3>";
    html+=renderTablaVotos(d.votos);
    html+="<h3>Quiniela final</h3>";
    html+=renderQuiniela(d.quiniela);
    html+="<div class='pleno-box'><strong>Pleno al 15</strong><br>";
    html+=d.pleno.local+" vs "+d.pleno.visitante+"</div>";

    ultimaContenido.innerHTML=html;
  });
}

/* TABLA VOTOS */
function renderTablaVotos(votos){
  const usuarios=Object.keys(votos);
  let html="<table><tr><th>Partido</th>";
  usuarios.forEach(u=>html+="<th>"+u+"</th>");
  html+="</tr>";

  for(let i=1;i<=14;i++){
    html+="<tr><td>"+i+"</td>";
    usuarios.forEach(u=>html+="<td>"+(votos[u][i]||"")+"</td>");
    html+="</tr>";
  }

  html+="<tr><td>Pleno L</td>";
  usuarios.forEach(u=>html+="<td>"+(votos[u]["PL15_LOCAL"]||"")+"</td>");
  html+="</tr>";

  html+="<tr><td>Pleno V</td>";
  usuarios.forEach(u=>html+="<td>"+(votos[u]["PL15_VISIT"]||"")+"</td>");
  html+="</tr>";

  html+="</table>";
  return html;
}

/* QUINIELA FINAL */
function renderQuiniela(q){
  let html="";
  q.partidos.forEach(p=>{
    const es=q.dobles.includes(p.partido);
    html+=`<div>
      Partido ${p.partido} ‚Üí 
      <span class="${es?'doble':''}">
      ${es? p.principal+" / "+p.segundo : p.principal}
      </span>
    </div>`;
  });
  return html;
}

/* CLASIFICACION */
function cargarClasificacion(){
  fetch(URL+"?action=clasificacion")
  .then(r=>r.json())
  .then(d=>{
    let html="<table><tr><th>üèÜ</th><th>Usuario</th><th>Puntos</th></tr>";
    d.slice(1).sort((a,b)=>b[1]-a[1]).forEach((r,i)=>{
      html+=`<tr>
        <td>${i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":""}</td>
        <td>${r[0]}</td>
        <td>${r[1]}</td>
      </tr>`;
    });
    html+="</table>";
    tablaClasificacion.innerHTML=html;
  });
}
</script>

</body>
</html>
