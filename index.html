<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Quiniela del Grupo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:16px;
}
h1 {
  background:#ffd700;
  padding:12px;
  text-align:center;
  border-radius:6px;
}
select, button {
  padding:6px;
  font-size:16px;
}
button {
  width:100%;
  margin-top:10px;
}
.tabs {
  display:flex;
  gap:6px;
  margin-top:10px;
}
.tabs button {
  flex:1;
}
.tab {
  display:none;
  background:#fff;
  padding:16px;
  border-radius:6px;
  margin-top:12px;
}
.tab.active {
  display:block;
}

/* Partidos */
.partido {
  display:grid;
  grid-template-columns: 1fr 70px;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}
.partido span {
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.partido select {
  width:70px;
}

/* Resultado */
.fila {
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}
.doble {
  color:#d63384;
  font-weight:bold;
}

/* Tablas */
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th, td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th {
  background:#eee;
}
</style>
</head>

<body>

<h1>Quiniela del Grupo</h1>

<label>¿Quién eres?</label>
<select id="usuario"></select>

<div class="tabs">
  <button onclick="mostrar('votar')">Votar</button>
  <button onclick="mostrar('ultima')">Última jornada</button>
  <button onclick="mostrar('historico')">Histórico</button>
  <button onclick="mostrar('clasificacion')">Clasificación</button>
</div>

<!-- ================= VOTAR ================= -->
<div id="votar" class="tab active">
  <h2>Votar quiniela</h2>
  <div id="partidos"></div>

  <h3>Pleno al 15</h3>
  <div id="pleno"></div>

  <button onclick="enviarVoto()">Enviar quiniela</button>
</div>

<!-- ================= ÚLTIMA ================= -->
<div id="ultima" class="tab">
  <h2>Última jornada</h2>
  <div id="ultimaJornada"></div>
</div>

<!-- ================= HISTÓRICO ================= -->
<div id="historico" class="tab">
  <h2>Histórico de jornadas</h2>
  <label>Selecciona jornada</label>
  <select id="selectorJornada"></select>
  <div id="detalleJornada"></div>
</div>

<!-- ================= CLASIFICACIÓN ================= -->
<div id="clasificacion" class="tab">
  <h2>Clasificación</h2>
  <div id="tablaClasificacion"></div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbwcvyozEik1vuu42WvrSkAFzhhO60BpVISshA9eSQMkfTA_MFM6gylR0FWPiaTOv_V4/exec";

/* ---------------- Navegación ---------------- */
function mostrar(id) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  if (id === "ultima") cargarUltima();
  if (id === "historico") cargarHistorico();
  if (id === "clasificacion") cargarClasificacion();
}

/* ---------------- Usuarios ---------------- */
fetch(URL + "?action=usuarios")
  .then(r => r.json())
  .then(u => {
    usuario.innerHTML = `<option value="">--</option>`;
    u.forEach(n => usuario.innerHTML += `<option>${n}</option>`);
  });

/* ---------------- Partidos ---------------- */
fetch(URL + "?action=partidos")
  .then(r => r.json())
  .then(p => {
    partidos.innerHTML = "";
    p.forEach(x => {
      partidos.innerHTML += `
        <div class="partido">
          <span title="${x.nombre}">${x.nombre}</span>
          <select name="p${x.id}">
            <option></option>
            <option>1</option>
            <option>X</option>
            <option>2</option>
          </select>
        </div>`;
    });
  });

/* ---------------- Pleno ---------------- */
fetch(URL + "?action=pleno")
  .then(r => r.json())
  .then(p => {
    pleno.innerHTML = `
      <div class="partido">
        <span>${p.local}</span>
        <select id="pl15_local">
          <option></option><option>0</option><option>1</option><option>2</option><option>M</option>
        </select>
      </div>
      <div class="partido">
        <span>${p.visitante}</span>
        <select id="pl15_visitante">
          <option></option><option>0</option><option>1</option><option>2</option><option>M</option>
        </select>
      </div>`;
  });

/* ---------------- Enviar voto ---------------- */
function enviarVoto() {
  if (!usuario.value) {
    alert("Selecciona tu nombre");
    return;
  }

  const p = new URLSearchParams();
  p.append("usuario", usuario.value);

  document.querySelectorAll("select[name^='p']")
    .forEach(s => p.append(s.name, s.value));

  p.append("pl15_local", pl15_local.value);
  p.append("pl15_visitante", pl15_visitante.value);

  fetch(URL + "?" + p.toString())
    .then(r => r.text())
    .then(t => alert(t === "OK" ? "✅ Voto registrado" : t));
}

/* ---------------- Última jornada ---------------- */
function cargarUltima() {
  fetch(URL + "?action=historico")
    .then(r => r.json())
    .then(h => {
      if (h.length === 0) {
        ultimaJornada.innerHTML = "No hay jornadas cerradas";
        return;
      }
      const ultima = h[h.length - 2]; // quiniela
      mostrarQuiniela(JSON.parse(ultima[3]), ultimaJornada);
    });
}

/* ---------------- Histórico ---------------- */
function cargarHistorico() {
  fetch(URL + "?action=historico")
    .then(r => r.json())
    .then(h => {
      selectorJornada.innerHTML = "";
      const jornadas = [...new Set(h.map(r => r[0]))];
      jornadas.forEach(j => selectorJornada.innerHTML += `<option value="${j}">Jornada ${j}</option>`);
      selectorJornada.onchange = () => mostrarJornada(h);
      selectorJornada.onchange();
    });
}

function mostrarJornada(h) {
  const j = selectorJornada.value;
  const q = h.find(r => r[0] == j && r[2] === "quiniela");
  if (!q) return;
  mostrarQuiniela(JSON.parse(q[3]), detalleJornada);
}

/* ---------------- Render quiniela ---------------- */
function mostrarQuiniela(data, contenedor) {
  let html = "";
  data.partidos.forEach(p => {
    const es = data.dobles.includes(p.partido);
    html += `
      <div class="fila">
        <span>Partido ${p.partido}</span>
        <span class="${es ? "doble" : ""}">
          ${es ? `${p.principal}/${p.segundo}` : p.principal}
        </span>
      </div>`;
  });
  contenedor.innerHTML = html;
}

/* ---------------- Clasificación ---------------- */
function cargarClasificacion() {
  fetch(URL + "?action=clasificacion")
    .then(r => r.json())
    .then(d => {
      let h = "<table><tr><th>Usuario</th><th>Puntos</th></tr>";
      d.slice(1).forEach(r => {
        h += `<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`;
      });
      h += "</table>";
      tablaClasificacion.innerHTML = h;
    });
}
</script>

</body>
</html>
