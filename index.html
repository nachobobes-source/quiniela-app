<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Quiniela del Grupo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:16px;
}
h1 {
  background:#ffd700;
  padding:12px;
  text-align:center;
  border-radius:6px;
}
select, button {
  padding:6px;
  font-size:16px;
}
button {
  width:100%;
  margin-top:12px;
}
.tabs button {
  width:32%;
}
.tab {
  display:none;
  background:#fff;
  padding:16px;
  border-radius:6px;
  margin-top:12px;
}
.tab.active { display:block; }

/* PARTIDOS */
.partido {
  display:grid;
  grid-template-columns: 1fr 70px;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}
.partido span {
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.partido select {
  width:70px;
}

/* RESULTADOS */
.fila {
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}
.doble {
  color:#d63384;
  font-weight:bold;
}
.pleno {
  margin-top:12px;
  padding:10px;
  background:#f8f9fa;
  border-radius:6px;
}
table {
  width:100%;
  border-collapse:collapse;
}
th, td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th { background:#eee; }
</style>
</head>

<body>

<h1>Quiniela del Grupo</h1>

<label>¿Quién eres?</label>
<select id="usuario"></select>

<div class="tabs">
  <button onclick="mostrar('votar')">Votar</button>
  <button onclick="mostrar('resultado')">Resultado</button>
  <button onclick="mostrar('clasificacion')">Clasificación</button>
</div>

<!-- VOTAR -->
<div id="votar" class="tab active">
  <h2>Votar</h2>
  <div id="partidos"></div>

  <h3>Pleno al 15</h3>
  <div id="pleno"></div>

  <button onclick="enviar()">Enviar quiniela</button>
</div>

<!-- RESULTADO -->
<div id="resultado" class="tab">
  <h2>Quiniela final</h2>
  <div id="quinielaFinal"></div>
</div>

<!-- CLASIFICACIÓN -->
<div id="clasificacion" class="tab">
  <h2>Clasificación</h2>
  <div id="tablaClasificacion"></div>
</div>

<script>
const URL = "https://script.google.com/macros/s/AKfycbyk5jP52iL_t8RRSeU_M5g-6qkJLyGTN1ZcL2He2Bcxbv4Unun5cwf5hkIveC5rTJuI/exec";

function mostrar(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="resultado") cargarResultado();
  if(id==="clasificacion") cargarClasificacion();
}

/* USUARIOS */
fetch(URL+"?action=usuarios")
  .then(r=>r.json())
  .then(u=>{
    usuario.innerHTML = `<option value="">--</option>`;
    u.forEach(n=>usuario.innerHTML+=`<option>${n}</option>`);
  });

/* PARTIDOS */
fetch(URL+"?action=partidos")
  .then(r=>r.json())
  .then(p=>{
    p.forEach(x=>{
      partidos.innerHTML+=`
        <div class="partido">
          <span title="${x.nombre}">${x.nombre}</span>
          <select name="p${x.id}">
            <option></option>
            <option>1</option>
            <option>X</option>
            <option>2</option>
          </select>
        </div>`;
    });
  });

/* PLENO (nombres desde backend implícito en resultado final) */
document.getElementById("pleno").innerHTML = `
  <div class="partido">
    <span>Equipo Local</span>
    <select id="pl15_local"><option></option><option>0</option><option>1</option><option>2</option><option>M</option></select>
  </div>
  <div class="partido">
    <span>Equipo Visitante</span>
    <select id="pl15_visitante"><option></option><option>0</option><option>1</option><option>2</option><option>M</option></select>
  </div>`;

/* ENVIAR */
function enviar(){
  if(!usuario.value){ alert("Selecciona usuario"); return; }
  const p=new URLSearchParams();
  p.append("usuario",usuario.value);
  document.querySelectorAll("select[name^='p']").forEach(s=>p.append(s.name,s.value));
  p.append("pl15_local",pl15_local.value);
  p.append("pl15_visitante",pl15_visitante.value);
  fetch(URL+"?"+p).then(r=>r.text()).then(t=>alert(t));
}

/* RESULTADO FINAL */
function cargarResultado(){
  fetch(URL+"?action=resultado")
    .then(r=>r.json())
    .then(d=>{
      let h="";
      d.partidos.forEach(p=>{
        const es=d.dobles.includes(p.partido);
        h+=`<div class="fila"><span>Partido ${p.partido}</span>
        <span class="${es?"doble":""}">${es?`${p.principal}/${p.segundo}`:p.principal}</span></div>`;
      });
      quinielaFinal.innerHTML=h;
    });
}

/* CLASIFICACIÓN */
function cargarClasificacion(){
  fetch(URL+"?action=clasificacion")
    .then(r=>r.json())
    .then(d=>{
      let h="<table><tr><th>Usuario</th><th>Puntos</th></tr>";
      d.slice(1).forEach(r=>h+=`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`);
      h+="</table>";
      tablaClasificacion.innerHTML=h;
    });
}
</script>

</body>
</html>
